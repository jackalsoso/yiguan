<html>
<head>
	<title>krpano - 2</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
	<meta http-equiv="x-ua-compatible" content="IE=edge" />
	<style>
		@-ms-viewport { width:device-width; }
		@media only screen and (min-device-width:800px) { html { overflow:hidden; } }
		html { height:100%; }
		body { height:100%; overflow:hidden; margin:0; padding:0; font-family:Arial, Helvetica, sans-serif; font-size:16px; color:#FFFFFF; background-color:#000000; }
	</style>

	<script type="text/javascript">
		var krpano = null;

		let scene_data = null;

		var url_data = new Array();

		function krpano_onready_callback(krpano_interface) {
	        krpano = krpano_interface;
	    }

	   
		function load(){
			document.querySelectorAll("#control_panle > input[type='text']").forEach(function(item){
				let id = item.getAttribute("id");
				default_size.set(id,item.value);
			})

			for(let i=1;i<=30;i++){
				let data = new Object();
				data.id = i;
				data.url = "real.png";
				url_data.push(data);
			}
		}

		function default_size_change(obj){
			let id = obj.getAttribute("id");
			default_size.set(id,obj.value);
		}

		function load_pano(id,name){
			embedpano({id:id,swf:"tour.swf", xml:name, target:"pano", html5:"auto", consolelog:true,mobilescale:1.0, passQueryParameters:true,onready: krpano_onready_callback});
		}

		function remove_pano(id){
			removepano(id);
		}

		function load_hotspot_info(scene_name){
			scene_data = null;
			all_data.find(function(item){
				if(Object.is(item.name,scene_name)){
					scene_data = item.hotspot;
					return true;
				}
			})
			load_hotspot_data(url_data);
		}

		function load_hotspot_data(frame_info){
			if(scene_data){
				frame_info.forEach(function(item){
					let picture_id = "picture_"+item.id;
					if(scene_data.hasOwnProperty(picture_id)){
						let picture_info = scene_data[picture_id];
						this.insert_hotspot_data(picture_info,item.url);
					}

					let nav_id = "nav_"+item.id;
					if(scene_data.hasOwnProperty(nav_id)){
						let nav_info = scene_data[nav_id];
						this.insert_hotspot_data(nav_info);
					}
				})
			}
		}


		function insert_hotspot_data(info,url){
			krpano.call("addhotspot('"+ info.name +"')");
	    	let edit_hotspot = krpano.get("hotspot['"+ info.name +"']");

	    	edit_hotspot.onclick = "click_hotspot(get(name))";
	    	Object.keys(info).forEach(function(key){
	    		if(edit_hotspot.hasOwnProperty(key)){
	    			edit_hotspot[key] = info[key];
	    		}
	    	})
	    	
	    	if(info.hotspot_type == 'nav'||info.name.startsWith("nav_")){
	    		//edit_hotspot.onloaded = "do_crop_animation(128,128, 60)"
	    	}else{
	    		var img = new Image();
	    		img.src = url;
	    		img.onload = function(){
	    			let width = this.width;
	    			let height = this.height;

	    			if(width/height > info.width/info.height){
	    				let real_height = info.width/(width/height);
	    				edit_hotspot.height = real_height;
	    			}else{
	    				let real_width = info.height * width / height;
	    				edit_hotspot.width = real_width;
	    			}

	    			edit_hotspot.url = url;
	    		}
	    	}
		}

	</script>

</head>
<body onload="load()">

<script src="tour.js"></script>
<script src="data.js"></script>

<div id="pano" style="width:100%;height:100%;">
	<noscript><table style="width:100%;height:100%;"><tr style="vertical-align:middle;"><td><div style="text-align:center;">ERROR:<br/><br/>Javascript not activated<br/><br/></div></td></tr></table></noscript>
	<script>
		embedpano({swf:"tour.swf", xml:"tour.xml", target:"pano", html5:"auto", consolelog:true,mobilescale:1.0, passQueryParameters:true,onready: krpano_onready_callback});
	</script>
</div>

<!--div style="position: absolute;left:0px;top:0px" id="control_panle">
相框默认宽度:<input type="text" id="frame_width" min="0" value="230" onchange="default_size_change(this)"/>
相框默认高度:<input type="text" id="frame_height" min="0" value="240" onchange="default_size_change(this)"/>
相框导航宽度:<input type="text" id="nav_width" min="0" value="60" onchange="default_size_change(this)"/>
相框导航高度:<input type="text" id="nav_height" min="0" value="60" onchange="default_size_change(this)"/><br>
<button onclick="open_insert('画1.png','hotspot')">添加相框</button>
<button onclick="open_insert('hotpoints.png','nav')">添加导航点</button><br>
<input type="file" id="hotspot_file"/><button onclick="load_hotspot_data(url_data)">加载热点</button><br>
<button onclick="save_hotspot()">输出</button><br>
<button onclick="load_pano('pano_1','tour.xml')">加载全景1</button><br>
<button onclick="load_pano('pano_1','tour1.xml')">加载全景2</button><br>
<button onclick="remove_pano('pano_1')">删除全景</button>
</div>

<div id="edit_panle" style="position: absolute;left: 0px;top:0px;border:1px solid red;background-color: #ccc" hidden>
	<input type="hidden" id="ath"/>
	<input type="hidden" id="atv"/>
	<input type="hidden" id="url"/>
	<input type="hidden" id="zoom"/>
	<input type="hidden" id="distorted"/>
	<input type="hidden" id="width"/>
	<input type="hidden" id="height"/>
	<input type="hidden" id="hotspot_type"/>
name:<input id="name" type="text" onchange="hotspot_change(this)" /><br>
width:<input id="width" type="number" min="0" max="800" value="0" step="1" onchange="hotspot_change(this)" /><br>
height:<input id="height" type="number" min="0" max="800" value="0" step="1" onchange="hotspot_change(this)" /><br>
rx:<input id="rx" type="number" min="-180" max="180" value="0" step="1" onchange="hotspot_change(this)" /><br>
ry:<input id="ry" type="number" min="-180" max="180" value="0" step="1" onchange="hotspot_change(this)" /><br>
rz:<input id="rz" type="number" min="-180" max="180" value="0" step="1" onchange="hotspot_change(this)" /><br>
ox:<input id="ox" type="number" min="-100" max="100" value="0" step="1" onchange="hotspot_change(this)" /><br>
oy:<input id="oy" type="number" min="-100" max="100" value="0" step="1" onchange="hotspot_change(this)" /><br>
scale:<input  id="scale" type="number" min="0" max="2" value="1" step="0.01" onchange="hotspot_change(this)" /><br>
<button onclick="delete_hotspot()">删除</button>
<button onclick="hidden_edit_panle()">确定</button-->
</div>

</body>
</html>
